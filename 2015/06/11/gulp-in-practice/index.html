<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>gulp in practice | lyyourc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
</head>

<body>
  <nav class="app-nav">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives">archive</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2015/06/11/gulp-in-practice/">gulp in practice</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">June 11 2015</p>
  </section>

  <section class="article-entry">
    <p>我们研究的例子是<a href="https://github.com/yeoman/generator-gulp-webapp/blob/master/app%2Ftemplates%2Fgulpfile.js" target="_blank" rel="external">generator-gulp-webapp</a>的gulp recipe.</p>
<h2 id="Getting-Start"><a href="#Getting-Start" class="headerlink" title="Getting Start"></a>Getting Start</h2><p>假设我正在开发一个项目。首先，我要用<code>jade</code>来写一个页面。那么，我们就需要<a href="https://www.npmjs.com/package/gulp-jade" target="_blank" rel="external">gulp-jade</a>来帮助把<code>jade</code>解析为<code>HTML</code>。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>),</div><div class="line"> $ = <span class="built_in">require</span>(<span class="string">'gulp-load-plugins'</span>)();</div><div class="line"></div><div class="line">gulp.task(<span class="string">'views'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  gulp.src(<span class="string">'app/views/index.jade'</span>)</div><div class="line">    .pipe($.plumber())</div><div class="line">    .pipe($.jade(&#123;</div><div class="line">        pretty: <span class="literal">true</span></div><div class="line">    &#125;))</div><div class="line">    .pipe(gulp.dest(<span class="string">'.tmp'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p> <code>require</code>是什么？他可以外部的一个模块，类似<code>java</code>的import。<a href="">详情请看</a></p>
<p>因为我们使用了<a href="https://www.npmjs.com/package/gulp-load-plugins" target="_blank" rel="external">gulp-load-plugins</a>，他会读取<code>package.json</code>里面的<code>devDependencies</code>或者<code>dependencies</code>的内容来加载plugins。比如，这是我的<code>package.json</code>:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"devDependencies"</span>: &#123;</div><div class="line">    <span class="attr">"gulp-jade"</span>: <span class="string">"^1.0.1"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以，我可以通过这样来加载<code>gulp-jade</code>模块<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ = <span class="built_in">require</span>(<span class="string">'gulp-load-plugins'</span>)();</div><div class="line">$.jade();</div></pre></td></tr></table></figure></p>
<p>否则的话，我就需要这样：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> jade = <span class="built_in">require</span>(<span class="string">'gulp-jade'</span>);</div></pre></td></tr></table></figure></p>
<p>上面这种方法，如果插件多起来的话，就要写很多变量名。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> jade = <span class="built_in">require</span>(<span class="string">'..'</span>),</div><div class="line">  sass = <span class="built_in">require</span>(<span class="string">'..'</span>),</div><div class="line">  <span class="comment">// ....</span></div><div class="line">  <span class="comment">//...</span></div></pre></td></tr></table></figure></p>
<p>然后，关于<code>gulp-jade</code>可以传哪些参数，可以看<a href="https://www.npmjs.com/package/gulp-jade#options" target="_blank" rel="external">docs</a>。</p>
<p>最后，<code>$.plumber</code>是用来捕捉并处理错误的。</p>
<h2 id="Next"><a href="#Next" class="headerlink" title="Next"></a>Next</h2><p>现在我想把bower_components里面的东西都inject到我的<code>index.jade</code>里面来，这样就不需要我手动写了。这个时候，我们需要用到<a href="https://github.com/taptapship/wiredep#gulpjs" target="_blank" rel="external">wiredep</a><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'wiredep'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  gulp.src(<span class="string">'app/views/index.jade'</span>)</div><div class="line">    pipe(wiredep(&#123;</div><div class="line">        <span class="comment">// options</span></div><div class="line">    &#125;))</div><div class="line">    .pipe(gulp.dest(<span class="string">'app/views/index.jade'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>如果像上面那样式不够的，因为wiredep根本不知道要把bower_compoents里面的东西插到<code>index.jade</code>的什么位置，因此我们要指定placeholder.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">doctype html</div><div class="line">  head</div><div class="line">    meta(charset=&apos;utf-8&apos;)</div><div class="line"></div><div class="line">    // bower:css</div><div class="line">    // endbower</div><div class="line"></div><div class="line">  body</div><div class="line">    p Goodbye world</div><div class="line"></div><div class="line">    // bower:js</div><div class="line">    // endbower</div></pre></td></tr></table></figure></p>
<p><code>wiredep</code>会默认会读取<code>bower.json</code>默认的<code>bower_compponets</code>路径，接着找到每个component里面的<code>bower.json</code>里的<code>main</code>property。</p>
<p>如果<code>main</code>里面没有指定相关的文件，<code>wiredep</code>是无法自动添加依赖到placeholder的。<a href="https://github.com/taptapship/wiredep#what-can-go-wrong" target="_blank" rel="external">docs - what can go wrong</a></p>
<p>举个例子：<code>semantic-ui</code>下的<code>bower.json</code>里的<code>main</code>没有指定他的CSS文件。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"main"</span>: [</div><div class="line">    <span class="string">"src/semantic.less"</span>,</div><div class="line">    <span class="string">"dist/semantic.js"</span></div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以你如果按照前面写的placeholder，你可以加载到<code>semantic,js</code>，但是无法添加<code>semantic.css</code>。因为我们上面的代码写的placeholder是要求css：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">doctype html</div><div class="line">html</div><div class="line">  head</div><div class="line">    meta(charset=&apos;utf-8&apos;)</div><div class="line">    title(My blog)</div><div class="line"></div><div class="line">    // bower:css</div><div class="line">    // endbower</div><div class="line"></div><div class="line">  body</div><div class="line">    p Goodbye world</div><div class="line"></div><div class="line">    // bower:js</div><div class="line">    script(src=&apos;../../bower_components/jquery/dist/jquery.js&apos;)</div><div class="line">    script(src=&apos;../../bower_components/semantic-ui/dist/semantic.js&apos;)</div><div class="line">    // endbower</div></pre></td></tr></table></figure></p>
<p>也就是说，我们要手动添加我们想要的文件到<code>main</code>property里面去，比如<code>dist/semantic.css</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;main&quot;: [</div><div class="line">    &quot;src/semantic.less&quot;,</div><div class="line">    &quot;dist/semantic.js&quot;,</div><div class="line">    &quot;dist/semantic.css&quot;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Issue"><a href="#Issue" class="headerlink" title="Issue"></a>Issue</h3><p>假设我们已经执行了<code>wiredep</code>任务，相关的依赖已经添加到了<code>index.jade</code>。接下来就要执行<code>views</code>任务，把jade解析成<code>HTML</code>到<code>.tmp</code>目录下。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- .tmp/index.html --&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- omit some tag here --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../../bower_components/semantic-ui/dist/semantic.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>如果你足够细心的话，你会发现引入的semantic的<strong>路径是不对的</strong>。因为<code>.tmp</code>是在根目录下面的，而本来<code>index.jade</code>实在<code>app/views</code>下面的。<br>正确的应该是这样：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/bower_components/semantic-ui/dist/semantic.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>所以我们要在<code>wiredep</code>的时候就要忽略掉<code>../..</code>这个字符串。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'wiredep'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  gulp.src(<span class="string">'app/views/index.jade'</span>)</div><div class="line">    pipe(wiredep(&#123;</div><div class="line">      ignorePath: <span class="regexp">/^(\.\.\/)*\.\./</span>  <span class="comment">// 去掉../..</span></div><div class="line">    &#125;))</div><div class="line">    .pipe(gulp.dest(<span class="string">'app/views/index.jade'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>话说，你不觉得这样引入多外部文件会不好吗？这样HTTP请求就变多了。所以，我们应该要把这些依赖都concatenate在同一个文件里面去。</p>
<p><a href="https://www.npmjs.com/package/gulp-useref" target="_blank" rel="external">gulp-assets</a>会把HTML的build block的引用的文件concatenate在一起。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'html'</span>, [<span class="string">'views'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> assets = $.useref.assets(&#123;searchPath: [<span class="string">'.tmp'</span>, <span class="string">'app'</span>, <span class="string">'.'</span>]&#125;);</div><div class="line"></div><div class="line">  gulp.src([<span class="string">'.tmp/*.html'</span>])</div><div class="line">    .pipe(assets)</div><div class="line">    .pipe($.<span class="keyword">if</span>(<span class="string">'*.js'</span>, $.uglify()))</div><div class="line">    .pipe($.<span class="keyword">if</span>(<span class="string">'*.css'</span>, $.csso()))</div><div class="line">    .pipe(assets.restore())</div><div class="line">    .pipe($.useref())</div><div class="line">    .pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>利用<a href="https://github.com/Snugug/gulp-subtree" target="_blank" rel="external">gulp-subtree</a>，把指定的目录提交奥到指定分支上面去。默认的分支是: <code>gh-page</code>。</p>
<p>所以，我们只需要把<code>dist</code>目录发布到<code>gh-page</code>分支上，我们就可以通过<code>username.github.io/repo-name</code>来访问了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'deploy'</span>, [<span class="string">'build'</span>], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  eturn gulp.src(<span class="string">'dist'</span>)</div><div class="line">    .pipe($.subtree())</div><div class="line">    .pipe($.clean());</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="Append-gulpfile-js"><a href="#Append-gulpfile-js" class="headerlink" title="Append: gulpfile.js"></a>Append: gulpfile.js</h2><p><a href="https://gist.github.com/DrakeLeung/bd9132aa68b45c3c6794" target="_blank" rel="external">https://gist.github.com/DrakeLeung/bd9132aa68b45c3c6794</a></p>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="http://7xrcp8.com1.z0.glb.clouddn.com/avatar.png" alt="avatar" />
    <div class="grid-item">
      <p class="title"> lyyourc </p>
      <p class="subtitle"> You Are The JavaScript In My HTML </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="DrakeLeung"
  href="https://twitter.com/intent/tweet?text=我们研究的例子是<a href="htt"
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'drakeleung';
  
  var disqus_url = 'http://drakeleung.github.io/blog/2015/06/11/gulp-in-practice/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>

</body>
</html>
