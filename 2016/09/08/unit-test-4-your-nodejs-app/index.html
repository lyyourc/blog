<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Node.js ä¹‹å•å…ƒæµ‹è¯• | lyyourc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
</head>

<body>
  <nav class="app-nav">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives">archive</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2016/09/08/unit-test-4-your-nodejs-app/">Node.js ä¹‹å•å…ƒæµ‹è¯•</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">September 08 2016</p>
  </section>

  <section class="article-entry">
    <h2 id="setup-node-js-app"><a class="header-anchor" href="#setup-node-js-app">#</a>Setup Node.js App</h2>
<p>( <strong>å¦‚æœå·²ç»å»ºå¥½äº† Node.js åº”ç”¨ï¼Œå¯ç›´æ¥è·³åˆ° <a href="#start-unit-test">ä¸‹ä¸€ä¸ªéƒ¨åˆ† - Start Unit Test</a></strong> )</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ <a href="https://github.com/koajs/koa" target="_blank" rel="external">koa</a>, <a href="http://mongoosejs.com" target="_blank" rel="external">mongoose</a> , <a href="https://github.com/lorenwest/node-config/" target="_blank" rel="external">config</a> åˆå§‹åŒ–æˆ‘ä»¬çš„é¡¹ç›®ã€‚<br>
å®Œæ•´ä»£ç å¯æŸ¥çœ‹ <img class="emoji" draggable="false" alt="ğŸ‘‰" src="https://twemoji.maxcdn.com/2/72x72/1f449.png"> <a href="">è¿™é‡Œ</a>ã€‚</p>
<p>é¦–å…ˆæ˜¯æˆ‘ä»¬çš„å…¥å£æ–‡ä»¶: <code>src/app.js</code> ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/app.js</span></div><div class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'koa'</span>)()</div><div class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</div><div class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'config'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'./router'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> &#123; mongo &#125; = config</div><div class="line"><span class="keyword">const</span> url = <span class="string">`mongodb://<span class="subst">$&#123;mongo.host&#125;</span>:<span class="subst">$&#123;mongo.port&#125;</span>/<span class="subst">$&#123;mongo.db&#125;</span>`</span></div><div class="line">mongoose.Promise = global.Promise</div><div class="line">mongoose.connect(url)</div><div class="line"></div><div class="line">app.use(router.routes())</div><div class="line"></div><div class="line">app.on(<span class="string">'error'</span>, err =&gt; <span class="built_in">console</span>.error(<span class="string">'onError'</span>, err))</div><div class="line">app.listen(config.port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`listening port <span class="subst">$&#123;config.port&#125;</span>`</span>))</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = app</div></pre></td></tr></table></figure>
<p>æ¥ç€æ˜¯æˆ‘ä»¬çš„è·¯ç”±æ–‡ä»¶ï¼š<code>src/router.js</code> ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/router.js</span></div><div class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</div><div class="line"></div><div class="line"><span class="keyword">const</span> heroCtrl = <span class="built_in">require</span>(<span class="string">'./apis/hero/hero.ctrl'</span>)</div><div class="line"></div><div class="line">router.get(<span class="string">'/api/hero'</span>, heroCtrl.getHeroes)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router</div></pre></td></tr></table></figure>
<p>ç„¶åå‘¢æ˜¯æˆ‘ä»¬çš„æ¥å£æ–‡ä»¶ï¼š<code>src/api/hero/hero.model.js</code>ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/api/hero/hero.model.js</span></div><div class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = mongoose.model(<span class="string">'hero'</span>, &#123;</div><div class="line">  name: <span class="built_in">String</span>,</div><div class="line">  skills: [<span class="built_in">String</span>],</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>ä»¥åŠå…¶å¯¹åº”çš„ controller: <code>src/api/hero/hero.ctrl.js</code> ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/api/hero/hero.ctrl.js</span></div><div class="line"><span class="keyword">const</span> heroModel = <span class="built_in">require</span>(<span class="string">'./hero.model'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> getHeroes = <span class="function"><span class="keyword">function</span> *(<span class="params">next</span>) </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">const</span> hero = <span class="keyword">yield</span> heroModel.find(&#123;&#125;)</div><div class="line">    <span class="keyword">this</span>.body = hero</div><div class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">    <span class="keyword">this</span>.throw(<span class="number">404</span>, e)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  getHeroes,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸ºäº†åœ¨ä¸åŒçš„å¼€å‘ç¯å¢ƒä¸‹ä½¿ç”¨ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† <a href="https://github.com/lorenwest/node-config/" target="_blank" rel="external">config</a> è¿™ä¸ªåŒ…ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// config/default.json</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"hero-dev"</span>,</div><div class="line">  <span class="string">"port"</span>: <span class="number">3000</span>,</div><div class="line">  <span class="string">"mongo"</span>: &#123;</div><div class="line">    <span class="string">"host"</span>: <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="string">"db"</span>: <span class="string">"hero-dev"</span>,</div><div class="line">    <span class="string">"port"</span>: <span class="number">27017</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åï¼Œæˆ‘ä»¬æ•´ä¸ª <code>package.json</code> æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"unit-test-for-nodejs-app"</span>,</div><div class="line">  <span class="string">"version"</span>: <span class="string">"0.0.1"</span>,</div><div class="line">  <span class="string">"description"</span>: <span class="string">"unit test for nodejs app"</span>,</div><div class="line">  <span class="string">"main"</span>: <span class="string">"app.js"</span>,</div><div class="line">  <span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"dev"</span>: <span class="string">"nodemon app.js"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"keywords"</span>: [</div><div class="line">    <span class="string">"unit-test"</span>,</div><div class="line">    <span class="string">"nodejs"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"author"</span>: <span class="string">"Drake Leung"</span>,</div><div class="line">  <span class="string">"license"</span>: <span class="string">"MIT"</span>,</div><div class="line">  <span class="string">"dependencies"</span>: &#123;</div><div class="line">    <span class="string">"config"</span>: <span class="string">"^1.21.0"</span>,</div><div class="line">    <span class="string">"koa"</span>: <span class="string">"^1.2.4"</span>,</div><div class="line">    <span class="string">"koa-router"</span>: <span class="string">"^5.4.0"</span>,</div><div class="line">    <span class="string">"mongodb"</span>: <span class="string">"^2.2.9"</span>,</div><div class="line">    <span class="string">"mongoose"</span>: <span class="string">"^4.6.0"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»ˆç«¯æ‰§è¡Œ <code>npm run dev</code> ä¾¿å¯ä»¥å¯åŠ¨æˆ‘ä»¬çš„åº”ç”¨ã€‚<br>
ç„¶åè®¿é—®æ¥å£ï¼š<code>localhost:3000/api/hero</code>ï¼Œä¼šè¿”å› <code>[]</code> ï¼Œå› ä¸ºæ•°æ®åº“é‡Œè¿˜æ²¡æœ‰æ•°æ®ã€‚</p>
<h2 id="start-unit-test"><a class="header-anchor" href="#start-unit-test">#</a>Start Unit Test</h2>
<p>åœ¨å¼€å§‹å†™æµ‹è¯•ä¹‹å‰ï¼Œæˆ‘ä»¬ä¹Ÿè®¸ä¼šæƒ³åˆ°å‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>å¦‚ä½•æ¨¡æ‹Ÿè®¿é—®ä¸€ä¸ªæ¥å£ã€‚</li>
<li>æ¥å£è¿”å›çš„æ•°æ®å“ªé‡Œæ¥ã€‚</li>
<li>æ¥å£è®¿é—®æœ‰æƒé™æ§åˆ¶æ€ä¹ˆåŠã€‚</li>
</ul>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°†ç”¨åˆ° <a href="https://github.com/mochajs/mocha" target="_blank" rel="external">mocha</a>, <a href="https://github.com/chaijs/chai" target="_blank" rel="external">chai</a> æ¥å†™æˆ‘ä»¬çš„å•å…ƒæµ‹è¯•ã€‚<br>
( åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åªè®¨è®ºå¦‚ä½•å†™æµ‹è¯•ï¼Œè€Œä¸è®¨è®ºå„ç§æµ‹è¯•æ¡†æ¶çš„ä¼˜åŠ£ã€‚)</p>
<p>é¦–å…ˆï¼Œå®‰è£…ä¾èµ–ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm i -D mocha chai</div></pre></td></tr></table></figure>
<p>æ¥ç€ï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ <code>test</code> ã€‚<br>
æ–°å»ºä¸€ä¸ªæ–‡ä»¶ <code>index.js</code> ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// test/index.js</span></div><div class="line"><span class="keyword">const</span> chai = <span class="built_in">require</span>(<span class="string">'chai'</span>)</div><div class="line"><span class="keyword">const</span> expect = chai.expect</div><div class="line"></div><div class="line">describe(<span class="string">'root app'</span>, () =&gt; &#123;</div><div class="line">  it(<span class="string">'should be ok'</span>, () =&gt; &#123;</div><div class="line">    expect(<span class="number">42</span>).to.be.exist</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>ç„¶åç»™æˆ‘ä»¬çš„ <code>package.json</code> æ·»åŠ ä¸€ä¸ª <code>script</code>ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"script"</span>: &#123;</div><div class="line">    <span class="string">"test"</span>: <span class="string">"mocha"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åæˆ‘ä»¬æ‰§è¡Œ <code>npm test</code> ï¼Œå°±å¯ä»¥çœ‹åˆ°æµ‹è¯•ç»“æœå•¦ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯ï¼Œè§£å†³æ‰ä¸Šé¢è®²åˆ°çš„é—®é¢˜ã€‚</p>
<blockquote>
<p>å¦‚ä½•æ¨¡æ‹Ÿè®¿é—®ä¸€ä¸ªæ¥å£ï¼Œæ¯”å¦‚ï¼š<code>/api/hero</code>ã€‚</p>
</blockquote>
<p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ° <a href="https://github.com/visionmedia/supertest" target="_blank" rel="external">supertest</a> ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm i -S supertest</div></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œå°±è®©æˆ‘ä»¬å…ˆæ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼š<code>test/apis/hero/hero.spec.js</code> ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> expect = <span class="built_in">require</span>(<span class="string">'chai'</span>).expect</div><div class="line"><span class="keyword">const</span> supertest = <span class="built_in">require</span>(<span class="string">'supertest'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> heroModel = <span class="built_in">require</span>(<span class="string">'../../../src/apis/hero/hero.model'</span>)</div><div class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'../../../src/app'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> req = supertest(app.listen())</div><div class="line"></div><div class="line">describe(<span class="string">'hero model'</span>, () =&gt; &#123;</div><div class="line">  describe(<span class="string">'GET /api/hero'</span>, () =&gt; &#123;</div><div class="line">    it(<span class="string">'should return all heros'</span>, done =&gt; &#123;</div><div class="line">      req.get(<span class="string">'/api/hero'</span>)</div><div class="line">        .expect(<span class="number">200</span>)</div><div class="line">        .expect(&#123; body &#125; =&gt; &#123;</div><div class="line">          expect(body).to.be([<span class="number">1</span>, <span class="number">2</span>])</div><div class="line">        &#125;, done)</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>æ¥ç€ä¿®æ”¹ <code>package.json</code>ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"test"</span>: <span class="string">"mocha test/**/*.spec.js"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥çš„æ˜¯é—®é¢˜ï¼š</p>
<blockquote>
<p>æ¥å£è¿”å›çš„æ•°æ®å“ªé‡Œæ¥ï¼Ÿ</p>
</blockquote>
<p>å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¯èƒ½çš„é—®é¢˜æ˜¯ï¼š</p>
<blockquote>
<p>æˆ‘ä»¬çš„æ¥å£é¦–å…ˆä¼šé€šè¿‡ã€Œæƒé™ç›¸å…³ã€çš„ä¸­é—´ä»¶ï¼Œæ€ä¹ˆç»•è¿‡ä»–ä»¬ï¼Ÿ</p>
</blockquote>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="http://7xrcp8.com1.z0.glb.clouddn.com/avatar.png" alt="avatar" />
    <div class="grid-item">
      <p class="title"> lyyourc </p>
      <p class="subtitle"> You Are The JavaScript In My HTML </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="DrakeLeung"
  href="https://twitter.com/intent/tweet?text= id="setup-node-js-a"
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'drakeleung';
  
  var disqus_url = 'http://drakeleung.github.io/blog/2016/09/08/unit-test-4-your-nodejs-app/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>

</body>
</html>
